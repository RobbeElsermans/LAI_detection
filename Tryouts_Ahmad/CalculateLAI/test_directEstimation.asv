clear
clc

addpath("..\..\Tryouts_Ahmad\")
addpath("..\ImageCreation\")
addpath("..\Statistics\")

directory = "..\..\..\Medium_Coverage";  % Replace '..\..\PLY files' with your directory path
files = dir(fullfile(directory, '*.bag'));

filepaths = cell(numel(files), 1);

% Display and store the names of all PLY files in the directory
for i = 1:numel(files)
    filepaths{i} = fullfile(directory, files(i).name);
    disp(filepaths{i});
end

for path=1:length(filepaths)

    pointcloud = ConvertBagToPointCloud(filepaths{path});
    pcshow(pointcloud)
    pause
    [slicedPointClouds,number] = SlicePointCloud(pointcloud, 2);

    zValues = cleancloud.Location(:, 3);
minZ = min(zValues);
maxZ = max(zValues);

% Define the thickness of each slice
%sliceThickness = 0.1;

% Initialize variables to store sliced point clouds
slicedPointClouds = cell(ceil((maxZ - minZ) / sliceThickness), 1);

% Slice the point cloud
currentSliceIndex = 1;
currentZ = minZ;

while currentZ < maxZ
    % Define the bounds of the current slice
    zMin = currentZ;
    zMax = currentZ + sliceThickness;

    % Extract points within the current slice
    indices = find(zValues >= zMin & zValues < zMax);
    slicedPointClouds{currentSliceIndex} = select(cleancloud, indices);

    % Move to the next slice
    currentZ = currentZ + sliceThickness;
    currentSliceIndex = currentSliceIndex + 1;
end

    normalizedCounts = CalculateNormalizedCounts(slicedPointClouds, 1280*780);
    Leaf_area_index = median_LAI_calculation(normalizedCounts);
    
    fprintf("file %s has an LAI of %f \n", filepaths{path}, Leaf_area_index)
end

